<!DOCTYPE html>
<html lang="pt-br">

<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<link rel="stylesheet" href="./css/style-perfil.css" />
	<link rel="shortcut icon" href="./imgs/chok 3.png" type="image/x-icon">

	<title>Perfil | Chokers</title>
</head>

<body onload="user(), listarPostsUsuario(), listarPessoasOnline()">
	<nav id="nav_perfil">
		<section id="sect_perfil_nav">
			<div class="div_nav_topo" id="div_nav_topo">
				<img src="./imgs/img_perfil-teste.jpg" alt="" id="img_perfil_nav" />

				<div class="div_perfil1_nav_topo"></div>

				<div class="div_perfil2_nav_topo"></div>
			</div>
		</section>

		<div class="div_nav">
			<div class="nome_user">
				<h1 class="nomeUsuario" id="nomeUsuarioNav">Roberto Carlos</h1>
				<p class="userUsuario" id="userUsuarioNav">@robeertinho</p>
			</div>

			<ul id="lista_nav">
				<a href="./perfil.html">
					<li>
						<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px"
							fill="currentcolor" class="icone_lista">
							<path
								d="M480-480q-66 0-113-47t-47-113q0-66 47-113t113-47q66 0 113 47t47 113q0 66-47 113t-113 47ZM160-160v-112q0-34 17.5-62.5T224-378q62-31 126-46.5T480-440q66 0 130 15.5T736-378q29 15 46.5 43.5T800-272v112H160Zm80-80h480v-32q0-11-5.5-20T700-306q-54-27-109-40.5T480-360q-56 0-111 13.5T260-306q-9 5-14.5 14t-5.5 20v32Zm240-320q33 0 56.5-23.5T560-640q0-33-23.5-56.5T480-720q-33 0-56.5 23.5T400-640q0 33 23.5 56.5T480-560Zm0-80Zm0 400Z" />
						</svg>
						<button>
							<h3>PERFIL</h3>
						</button>
					</li>
				</a>
				<a href="./feed.html">
					<li>
						<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px"
							fill="currentcolor" class="icone_lista">
							<path
								d="M240-200h120v-240h240v240h120v-360L480-740 240-560v360Zm-80 80v-480l320-240 320 240v480H520v-240h-80v240H160Zm320-350Z" />
						</svg>
						<h3>HOME</h3>
					</li>
				</a>
				<li style="opacity: 0%;">
					<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px"
						fill="currentcolor">
						<path
							d="M440-120v-240h80v80h320v80H520v80h-80Zm-320-80v-80h240v80H120Zm160-160v-80H120v-80h160v-80h80v240h-80Zm160-80v-80h400v80H440Zm160-160v-240h80v80h160v80H680v80h-80Zm-480-80v-80h400v80H120Z" />
					</svg>
					<button>
						<h3>CONFIGURA√á√ïES</h3>
					</button>
				</li>


				<span id="span_sair" onclick="sair()">
					<a href="#" id="a_sair">
						<li>
							<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px"
								fill="currentcolor" class="icone_lista">
								<path
									d="M200-120q-33 0-56.5-23.5T120-200v-560q0-33 23.5-56.5T200-840h280v80H200v560h280v80H200Zm440-160-55-58 102-102H360v-80h327L585-622l55-58 200 200-200 200Z" />
							</svg>
							<h3>SAIR</h3>
						</li>
					</a>
				</span>

			</ul>
		</div>
	</nav>

	<main id="main_perfil">
		<section id="sect_perfil_main">
			<div class="div_main_topo">
				<div class="div_pfp" id="div_pfp">
					<img src="./imgs/img_perfil-teste.jpg" alt="" id="img_perfil_main" />
				</div>

				<div class="div_perfil1_main_topo"></div>

				<div class="div_perfil2_main_topo" id="div_banner">
					<img src="./imgs/img-header-teste.jpg" alt="" id="img_header_main" />
				</div>
			</div>
		</section>

		<section id="sect_bio">
			<div class="div_corpo_bio">
				<div class="nome_user" id="nome_user_main">
					<h1 class="nomeConvidado" id="nome_convidado">Roberto Carlos</h1>
					<p class="userConvidado" id="user_convidado">@robeertinho</p>
				</div>
			</div>

			<p id="p_bio_convidado">
				ùêóùêï. l Â∫äÂçï ‚ùÄÍìº outono, folhas. lembro de quando seu sorriso soprou
				ventos de calma em mim.
			</p>

		</section>

		<div id="feed-container"></div>
	</main>

	<aside id="aside_perfil">



		<section id="sec_pessoas_online">

			<h1 id="titulo_online">Usuarios online</h1>



		</section>

	</aside>
</body>

</html>

<style>
	@import url("https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap");
</style>

<script>
	var modalAberto = false;

	var nomeUsuario = sessionStorage.NOME_USUARIO;
	var emailUsuario = sessionStorage.EMAIL_USUARIO;
	var userUsuario = sessionStorage.USER_USUARIO;
	var idUsuario = sessionStorage.ID_USUARIO;
	var pfpUsuario = sessionStorage.PFP_USUARIO;

	var idConvidado = sessionStorage.ID_CONVIDADO;

	var userConvidado = "";
	var nomeConvidado = "";
	var pfpConvidado = "";
	var bannerConvidado = "";
	var bioConvidado = "";



	function convidado(idConvidado) {
		fetch(`/usuarios/convidado/${idConvidado}`, {})
			.then((res) => res.json())
			.then((convidado) => {
				console.log(convidado[0]);

				nomeConvidado = convidado[0].nomeUsuario;
				userConvidado = convidado[0].userUsuario;
				pfpConvidado = convidado[0].pfpUsuario;
				bannerConvidado = convidado[0].bannerUsuario;
				bioConvidado = convidado[0].bioUsuario;

				if (bioConvidado == null) {
					bioConvidado = " "
				}

				div_pfp.innerHTML = `

   <img src="./assets/foto_perfil/${pfpConvidado}" alt="" id="img_perfil_main">
                `;

				div_banner.innerHTML = `<img src="./assets/foto_perfil/${bannerConvidado}" alt="" id="img_header_main">
`;
				console.log(`nome: ${nomeConvidado}`);
				console.log(`id: ${idConvidado}`);
				console.log(`user: ${userConvidado}`);


				userConvidado.innerHTML = `@${userConvidado}`
				nome_convidado.innerHTML = `${nomeConvidado}`
				user_convidado.innerHTML = `@${userConvidado}`
				p_bio_convidado.innerHTML = `${bioConvidado}`
			});
	}


	//moldals

	var modalEditarPerfil = "sec_editarPerfil_modal";
	var modalCriarChoke = "div_criar_chok";

	function user() {
		console.log(`nome: ${nomeUsuario}`);
		console.log(`email: ${emailUsuario}`);
		console.log(`id: ${idUsuario}`);
		console.log(`user: ${userUsuario}`);

		document.documentElement.style.setProperty('--var-cor-primaria', sessionStorage.CORPRI);


		document.documentElement.style.setProperty(
			"--var-cor-secundaria",
			sessionStorage.CORSEC
		);

		document.documentElement.style.setProperty(
			"--var-cor-terciaria",
			sessionStorage.CORTERC
		);

		document.documentElement.style.setProperty(
			"--var-cor-secundaria-escura",
			sessionStorage.CORSECE
		);

		// document
		// 	.querySelectorAll(".nomeUsuario")
		// 	.forEach((h1) => (h1.innerHTML = nomeUsuario));
		// document
		// 	.querySelectorAll(".userUsuario")
		// 	.forEach((p) => (p.innerHTML = `@${userUsuario}`));

		userUsuarioNav.innerHTML = `@${userUsuario}`;
		nomeUsuarioNav.innerHTML = nomeUsuario;


		img_perfil_nav.src = `./assets/foto_perfil/${pfpUsuario}`;

		convidado(idConvidado);
	}

	function abrirModal(modalId) {
		console.log("tentando abrir o modal");

		const modal = document.getElementById(modalId); // Corrigido

		if (modalAberto) {
			modal.style.display = "block";
			modal.style.left = "-50%";
			modalAberto = false;

			nav_perfil.classList.remove("blur");
			main_perfil.classList.remove("blur");
			aside_perfil.classList.remove("blur");
		} else {
			modal.style.display = "block";
			modal.style.left = "50%";
			modalAberto = true;

			nav_perfil.classList.add("blur");
			main_perfil.classList.add("blur");
			aside_perfil.classList.add("blur");
		}
	}

	function salvarEdicao() {
		var nomeVar = nome_usario_editar.value;
		var bioVar = bio_usuario_editar.value;
		const imagem = pfpUsuario;

		const formData = new FormData();
		formData.append("foto", imagem);
		formData.append("nomeUsuario", nomeVar);
		formData.append("bioUsuario", bioVar);
		formData.append("idUsuario", idUsuario);

		fetch("/usuarios/editar", {
			method: "POST",
			body: formData,
		})
			// .then(res => res.json())
			.then((resposta) => {
				console.log("Edi√ß√£o feita com sucesso com sucesso!");
				abrirModal();
			})
			.catch((err) => {
				console.log(`#ERRO: ${err}`);
			});
	}

	function listarPostsUsuario() {
		fetch(`/usuarios/${idConvidado}`, {})
			.then((response) => response.json())

			.then((dadosPost) => {
				const feedContainer = document.getElementById("feed-container");
				feedContainer.innerHTML = "";

				dadosPost.forEach((post) => {
					const postDiv = document.createElement("div");
					postDiv.className = "div_post";

					const section = document.createElement("section");
					section.className = "sect_perfil_post";

					const topo = document.createElement("div");
					topo.className = "div_post_topo";

					const imgPerfil = document.createElement("img");
					imgPerfil.src = `./assets/foto_perfil/${pfpConvidado}`;
					imgPerfil.className = "img_perfil_post";

					const div1 = document.createElement("div");
					div1.className = "div_perfil1_post_topo";

					const div2 = document.createElement("div");
					div2.className = "div_perfil2_post_topo";

					const nomeDiv = document.createElement("div");
					nomeDiv.className = "nome_user";

					const h1 = document.createElement("h1");
					h1.className = "nomeUsuario";
					h1.textContent = post.nomeUsuario;

					const p = document.createElement("p");
					p.className = "userUsuario";
					p.textContent = `@${post.userUsuario}`;

					nomeDiv.appendChild(h1);
					nomeDiv.appendChild(p);
					div2.appendChild(nomeDiv);
					topo.appendChild(imgPerfil);
					topo.appendChild(div1);
					topo.appendChild(div2);
					section.appendChild(topo);

					// Corpo do post
					const corpo = document.createElement("div");
					corpo.className = "div_corpo_post";

					const descDiv = document.createElement("div");
					descDiv.className = "div_post_desc";

					const descP = document.createElement("p");
					descP.className = "p_descPost";
					descP.textContent = post.descPost;

					descDiv.appendChild(descP);

					if (post.imgPost != "null") {
						const imgDiv = document.createElement("div");
						imgDiv.className = "div_post_img";

						const imgPost = document.createElement("img");
						imgPost.id = "img_corpo_post";
						imgPost.src = `assets/${post.imgPost}`;

						imgDiv.appendChild(imgPost);

						corpo.appendChild(imgDiv);
					}

					corpo.appendChild(descDiv);
					postDiv.appendChild(section);
					postDiv.appendChild(corpo);

					feedContainer.appendChild(postDiv);
				});
			})
			.catch((err) => {
				console.log(`#ERRO: ${err}`);
			});
	}

	function criar_post() {
		const descPostVar = textarea_comentairo.value;
		const imagem = foto.files[0];

		const formData = new FormData();
		formData.append("foto", imagem);
		formData.append("descPost", descPostVar);
		formData.append("idUsuario", idUsuario);

		fetch("/post/postar", {
			method: "POST",
			body: formData,
		})
			// .then(res => res.json())
			.then((resposta) => {
				console.log("Post realizado com sucesso!");
				fechar_popup();
				listarPosts(); // recarregar feed
			})
			.catch((err) => {
				console.log(`#ERRO: ${err}`);
			});
	}



	function listarPessoasOnline() {


		fetch(`usuarios/listarPessoasOnline/${idUsuario}`)
			.then((response) => response.json())
			.then((online) => {

				const sec_pessoas_online = document.getElementById("sec_pessoas_online")

				console.log("quem online" + online[0])


				online.forEach((quemOnline) => {

					console.log("quem online" + quemOnline[0])

					const idConvidado = quemOnline.idOnline
					const div_online = document.createElement('div')
					div_online.className = "div_quem_online"

					const div_topo_online = document.createElement('div')
					div_topo_online.className = "div_topo_online"

					const img_online = document.createElement("img")
					img_online.src = `assets/foto_perfil/${quemOnline.pfpQuemOnline}`
					img_online.className = `pfp_quem_online`
					img_online.style.cursor = "pointer"
					img_online.onclick = () => buscarPerfil(idConvidado);

					div_online.appendChild(img_online)

					const div_info_usuario = document.createElement("div")
					div_info_usuario.className = "div_info_online"

					const nome_usuario = document.createElement("h1")
					nome_usuario.textContent = `${quemOnline.nomeOnline}`

					const user_usuario = document.createElement("p")
					user_usuario.textContent = `@${quemOnline.userOnline}`

					div_info_usuario.appendChild(nome_usuario)
					div_info_usuario.appendChild(user_usuario)

					const div_banner_online = document.createElement('div')
					div_banner_online.className = "div_banner_online"

					const img_banner_online = document.createElement('img')
					img_banner_online.src = `assets/foto_perfil/${quemOnline.bannerQuemOnline}`
					img_banner_online.id = `img_banner_online_${idConvidado}`

					div_banner_online.appendChild(img_banner_online)



					div_topo_online.appendChild(img_online)
					div_topo_online.appendChild(div_info_usuario)

					div_online.appendChild(div_topo_online)

					div_online.appendChild(div_banner_online)

					sec_pessoas_online.appendChild(div_online)




				})


			})


	}

	function buscarPerfil(idConvidado) {
		console.log(idConvidado);

		sessionStorage.ID_CONVIDADO = idConvidado;

		window.location = "perfilSeguidor.html";
	}


	function sair() {

		fetch(`/usuarios/status/${idUsuario}`, {
			method: "POST",
			headers: {
				"Content-Type": "application/json",
			},
			body: JSON.stringify({
				statusUsuario: 0,
			}),
		}).then(function (resposta) {
			console.log("resposta: ", resposta);

			window.location = "index.html";
		});
	}

	window.onbeforeunload = () => {

		const status = {
			statusUsuario: 0
		};

		const blob = new Blob([JSON.stringify(status)], { type: 'application/json' });

		navigator.sendBeacon(`usuarios/status/${idUsuario}`, blob)


	}


</script>